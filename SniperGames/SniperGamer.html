<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Jogo 2D Top-Down</title>
<style>
  body {
    margin: 0;
    background: #111;
    overflow: hidden;
    font-family: Arial, sans-serif;
  }
  canvas {
    display: block;
    margin: auto;
    background: #111;
    border: 2px solid #222;
  }
  #hud {
    position: fixed;
    top: 5px;
    left: 50%;
    transform: translateX(-50%);
    color: #0f0;
    font-weight: bold;
    font-size: 18px;
    user-select: none;
    z-index: 5;
  }
  #message {
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: orange;
    display: none;
    text-shadow: 0 0 10px orange;
    z-index: 10;
  }
</style>
</head>
<body>
<div id="hud"></div>
<div id="message">BOSS CHEGANDO!</div>
<canvas id="game" width="800" height="600"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const hud = document.getElementById('hud');
const message = document.getElementById('message');

// MAPA
const mapW = 1600, mapH = 1200;

// PLAYER
const player = {x:mapW/2,y:mapH/2,w:30,h:30,speed:4,vida:100,angle:0};

// VARIÁVEIS
let pontos=0;
let maxInimigos=10;
let inimigos=[];
let tiros=[];
let caixasCura = [];
let keys={};
let shooting=false;
let mouseX=0,mouseY=0;
const fireRate=150;
let lastShot=0;
let normalSpeed=1.2, forteSpeed=0.8;

// CAMERA
const camera={x:0,y:0,w:canvas.width,h:canvas.height};

// EVENTOS
window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

canvas.addEventListener('mousemove',e=>{
  const rect=canvas.getBoundingClientRect();
  mouseX=e.clientX-rect.left;
  mouseY=e.clientY-rect.top;
});
canvas.addEventListener('mousedown',()=>shooting=true);
canvas.addEventListener('mouseup',()=>shooting=false);

// FUNÇÕES
function criarInimigo(tipo=1){
  let inimigo={
    x:Math.random()*(mapW-40)+20,
    y:Math.random()*(mapH-40)+20,
    tipo:tipo,
    vida:tipo===1?1:tipo===2?3:20,
    dano:tipo===1?10:tipo===2?20:50,
    w:tipo===3?60:25,
    h:tipo===3?60:25
  };
  inimigos.push(inimigo);
}

function spawnBoss(){
  message.style.display='block';
  setTimeout(()=>message.style.display='none',3000);
  criarInimigo(3);
}

function criarCaixaCura() {
  caixasCura.push({
    x: Math.random() * (mapW - 30) + 15,
    y: Math.random() * (mapH - 30) + 15,
    w: 25,
    h: 25,
  });
}

function colisao(r1,r2){
  return r1.x<r2.x+r2.w&&r1.x+r1.w>r2.x&&r1.y<r2.y+r2.h&&r1.y+r1.h>r2.y;
}

function moverPlayer(){
  if(keys['w']||keys['arrowup'])player.y-=player.speed;
  if(keys['s']||keys['arrowdown'])player.y+=player.speed;
  if(keys['a']||keys['arrowleft'])player.x-=player.speed;
  if(keys['d']||keys['arrowright'])player.x+=player.speed;
  player.x=Math.max(0,Math.min(mapW-player.w,player.x));
  player.y=Math.max(0,Math.min(mapH-player.h,player.y));
}

function moverInimigos(){
  inimigos.forEach(i=>{
    const dx=player.x-i.x;
    const dy=player.y-i.y;
    const dist=Math.hypot(dx,dy);
    let speed;
    if(i.tipo===1) speed = normalSpeed;
    else if(i.tipo===2) speed = forteSpeed;
    else if(i.tipo===3) speed = 1.5;  // BOSS mais rápido
    else speed = 1;

    if(dist>0){
      i.x+=dx/dist*speed;
      i.y+=dy/dist*speed;
    }
  });
}

function moverTiros(){
  tiros=tiros.filter(t=>{
    t.x+=t.vx;
    t.y+=t.vy;
    return t.x>0&&t.x<mapW&&t.y>0&&t.y<mapH;
  });
}

function atirar(){
  const now=performance.now();
  if(shooting&&now-lastShot>fireRate){
    lastShot=now;
    const ang=player.angle;
    const speed=10;
    const tx=player.x+player.w/2+Math.cos(ang)*25;
    const ty=player.y+player.h/2+Math.sin(ang)*25;
    tiros.push({x:tx,y:ty,vx:Math.cos(ang)*speed,vy:Math.sin(ang)*speed,size:8});
  }
}

function atualizarColisoes(){
  // tiros vs inimigos
  let novosInimigos=[];
  for(let i=0;i<inimigos.length;i++){
    let inim=inimigos[i];
    for(let t=tiros.length-1;t>=0;t--){
      const tiro=tiros[t];
      if(colisao({x:tiro.x-4,y:tiro.y-4,w:8,h:8},{x:inim.x,y:inim.y,w:inim.w,h:inim.h})){
        tiros.splice(t,1);
        inim.vida--;
        if(inim.vida<=0){
          pontos++;
          if(pontos%10===0) spawnBoss();
          else if(pontos%3===0){
            maxInimigos++;
            normalSpeed+=0.05;
            forteSpeed+=0.03;
          }
        }
      }
    }
    if(inim.vida>0)novosInimigos.push(inim);
  }
  inimigos=novosInimigos;

  // inimigos vs player
  for(let i=inimigos.length-1;i>=0;i--){
    let inim=inimigos[i];
    if(colisao({x:player.x,y:player.y,w:player.w,h:player.h},{x:inim.x,y:inim.y,w:inim.w,h:inim.h})){
      inimigos.splice(i,1);
      player.vida-=inim.dano;
      if(player.vida<=0){
        alert('Você morreu! Pontos: '+pontos);
        resetGame();
        return;
      }
    }
  }
}

function checarCaixasCura() {
  for(let i = caixasCura.length - 1; i >= 0; i--) {
    let c = caixasCura[i];
    if(colisao({x: player.x, y: player.y, w: player.w, h: player.h}, c)) {
      player.vida = Math.min(100, player.vida + 10);
      caixasCura.splice(i,1);
    }
  }
}

function atualizarCamera(){
  camera.x=player.x+player.w/2-camera.w/2;
  camera.y=player.y+player.h/2-camera.h/2;
  camera.x=Math.max(0,Math.min(mapW-camera.w,camera.x));
  camera.y=Math.max(0,Math.min(mapH-camera.h,camera.y));
}

function desenharFundo(){
  ctx.fillStyle='#111';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  const grid=50;
  ctx.strokeStyle='#222';
  for(let x=-camera.x%grid;x<canvas.width;x+=grid){
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();
  }
  for(let y=-camera.y%grid;y<canvas.height;y+=grid){
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();
  }
}

function desenharPlayer(){
  const cx=player.x+player.w/2,cy=player.y+player.h/2;
  player.angle=Math.atan2(mouseY+camera.y-cy,mouseX+camera.x-cx);
  ctx.save();
  ctx.translate(cx-camera.x,cy-camera.y);
  ctx.rotate(player.angle);
  ctx.fillStyle='lime';
  ctx.fillRect(-player.w/2,-player.h/2,player.w,player.h);
  ctx.fillStyle='gray';
  ctx.fillRect(player.w/2,-5,25,10);
  ctx.restore();
}

function desenharInimigos(){
  inimigos.forEach(i=>{
    ctx.fillStyle=i.tipo===1?'red':i.tipo===2?'orange':'purple';
    ctx.fillRect(i.x-camera.x,i.y-camera.y,i.w,i.h);
  });
}

function desenharTiros(){
  ctx.fillStyle='limegreen';
  tiros.forEach(t=>{
    ctx.beginPath();
    ctx.arc(t.x-camera.x,t.y-camera.y,t.size/2,0,Math.PI*2);
    ctx.fill();
  });
}

function desenharCaixasCura() {
  caixasCura.forEach(c=>{
    ctx.fillStyle = 'cyan';
    ctx.fillRect(c.x - camera.x, c.y - camera.y, c.w, c.h);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.strokeRect(c.x - camera.x, c.y - camera.y, c.w, c.h);
    // Cruz de cura
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 3;
    const cx = c.x + c.w/2 - camera.x;
    const cy = c.y + c.h/2 - camera.y;
    ctx.beginPath();
    ctx.moveTo(cx - 7, cy);
    ctx.lineTo(cx + 7, cy);
    ctx.moveTo(cx, cy - 7);
    ctx.lineTo(cx, cy + 7);
    ctx.stroke();
  });
}

function atualizarHUD(){
  hud.textContent=`Vida: ${player.vida} | Pontos: ${pontos}`;
}

function resetGame(){
  player.vida=100;
  pontos=0;
  maxInimigos=10;
  normalSpeed=1.2;forteSpeed=0.8;
  inimigos=[];tiros=[];caixasCura=[];
  player.x=mapW/2;player.y=mapH/2;
  for(let i=0;i<maxInimigos;i++)criarInimigo(Math.random()<0.3?2:1);
  for(let i=0; i<5; i++) criarCaixaCura();
}

function loop(){
  atualizarCamera();
  moverPlayer();
  checarCaixasCura();
  moverInimigos();
  moverTiros();
  atualizarColisoes();
  atirar();

  // garantir spawn inimigos
  let vivos=inimigos.filter(i=>i.tipo!==3).length;
  while(vivos<maxInimigos){
    criarInimigo(Math.random()<0.3?2:1);
    vivos++;
  }

  desenharFundo();
  desenharCaixasCura();
  desenharInimigos();
  desenharTiros();
  desenharPlayer();
  atualizarHUD();

  requestAnimationFrame(loop);
}

resetGame();
loop();
</script>
</body>
</html>
